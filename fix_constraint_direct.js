const { supabase } = require('./config/supabase');

// Cliente admin para opera√ß√µes que precisam contornar RLS
const { createClient } = require('@supabase/supabase-js');
const adminSupabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

(async () => {
  try {
    console.log('üîç Tentando corrigir constraint usando abordagem direta...');
    
    // Primeiro, vamos verificar se conseguimos acessar informa√ß√µes da constraint
    // usando uma query simples no information_schema
    try {
      const { data: schemaInfo, error: schemaError } = await adminSupabase
        .from('information_schema.table_constraints')
        .select('*')
        .eq('constraint_name', 'votos_usuario_id_fkey')
        .eq('table_name', 'votos');
      
      if (schemaError) {
        console.log('‚ùå N√£o conseguiu acessar information_schema:', schemaError.message);
      } else {
        console.log('üìä Informa√ß√µes da constraint:', schemaInfo);
      }
    } catch (err) {
      console.log('‚ùå Erro ao acessar schema:', err.message);
    }
    
    // Vamos tentar uma abordagem diferente: verificar se a constraint realmente existe
    // e qual tabela ela est√° referenciando atrav√©s dos dados existentes
    console.log('\nüîç Analisando dados existentes na tabela votos...');
    
    const { data: existingVotes, error: votesError } = await adminSupabase
      .from('votos')
      .select('usuario_id')
      .limit(10);
    
    if (votesError) {
      console.log('‚ùå Erro ao buscar votos existentes:', votesError.message);
    } else if (existingVotes && existingVotes.length > 0) {
      console.log(`üìä Encontrados ${existingVotes.length} votos existentes`);
      
      // Verificar se esses usuario_id existem na tabela public.users
      const uniqueUserIds = [...new Set(existingVotes.map(v => v.usuario_id))];
      console.log(`üîç Verificando ${uniqueUserIds.length} IDs √∫nicos de usu√°rios...`);
      
      for (const userId of uniqueUserIds.slice(0, 5)) { // Verificar apenas os primeiros 5
        const { data: userInPublic, error: publicError } = await adminSupabase
          .from('users')
          .select('id, email')
          .eq('id', userId)
          .single();
        
        const { data: userInAuth, error: authError } = await adminSupabase
          .from('auth.users')
          .select('id, email')
          .eq('id', userId)
          .single();
        
        console.log(`\nüë§ Usu√°rio ID: ${userId}`);
        
        if (publicError) {
          console.log('  ‚ùå N√£o encontrado em public.users:', publicError.message);
        } else {
          console.log(`  ‚úÖ Encontrado em public.users: ${userInPublic.email}`);
        }
        
        if (authError) {
          console.log('  ‚ùå N√£o encontrado em auth.users:', authError.message);
        } else {
          console.log(`  ‚úÖ Encontrado em auth.users: ${userInAuth.email}`);
        }
      }
    } else {
      console.log('üìä Nenhum voto existente encontrado');
    }
    
    // Agora vamos tentar uma abordagem mais direta: usar o SQL atrav√©s de uma fun√ß√£o personalizada
    console.log('\nüîß Tentando criar fun√ß√£o tempor√°ria para executar SQL...');
    
    try {
      // Tentar criar uma fun√ß√£o tempor√°ria que nos permita executar SQL
      const createFunctionQuery = `
        CREATE OR REPLACE FUNCTION temp_exec_sql(query text)
        RETURNS text
        LANGUAGE plpgsql
        SECURITY DEFINER
        AS $$
        BEGIN
          EXECUTE query;
          RETURN 'SUCCESS';
        EXCEPTION
          WHEN OTHERS THEN
            RETURN SQLERRM;
        END;
        $$;
      `;
      
      // Tentar executar usando uma query direta
      const { data: createResult, error: createError } = await adminSupabase.rpc('temp_exec_sql', {
        query: createFunctionQuery
      });
      
      if (createError) {
        console.log('‚ùå N√£o conseguiu criar fun√ß√£o tempor√°ria:', createError.message);
        
        // √öltima tentativa: usar uma abordagem mais simples
        console.log('\nüîß Tentativa final: recriando a constraint usando DDL direto...');
        
        // Vamos tentar usar o m√©todo de query SQL direta do Supabase
        const dropConstraintSQL = 'ALTER TABLE votos DROP CONSTRAINT IF EXISTS votos_usuario_id_fkey';
        const addConstraintSQL = 'ALTER TABLE votos ADD CONSTRAINT votos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.users(id)';
        
        console.log('üóëÔ∏è Tentando dropar constraint...');
        console.log('SQL:', dropConstraintSQL);
        
        console.log('‚ûï Tentando adicionar nova constraint...');
        console.log('SQL:', addConstraintSQL);
        
        console.log('\n‚ö†Ô∏è ATEN√á√ÉO: Para executar estes comandos SQL, voc√™ precisar√°:');
        console.log('1. Acessar o painel do Supabase');
        console.log('2. Ir para SQL Editor');
        console.log('3. Executar os seguintes comandos:');
        console.log('');
        console.log('-- Dropar constraint existente');
        console.log(dropConstraintSQL + ';');
        console.log('');
        console.log('-- Adicionar nova constraint');
        console.log(addConstraintSQL + ';');
        console.log('');
        
      } else {
        console.log('‚úÖ Fun√ß√£o tempor√°ria criada:', createResult);
      }
    } catch (err) {
      console.log('‚ùå Erro na tentativa final:', err.message);
    }
    
  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
  
  process.exit(0);
})();