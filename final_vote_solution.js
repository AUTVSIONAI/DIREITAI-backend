const { supabase } = require('./config/supabase');

// Cliente admin para opera√ß√µes que precisam contornar RLS
const { createClient } = require('@supabase/supabase-js');
const adminSupabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

(async () => {
  try {
    console.log('üîß SOLU√á√ÉO FINAL PARA O PROBLEMA DE VOTOS');
    console.log('=' .repeat(50));
    
    // 1. Analisar dados existentes
    console.log('\nüìä 1. Analisando dados existentes...');
    
    const { data: existingVotes, error: votesError } = await adminSupabase
      .from('votos')
      .select('*');
    
    if (votesError) {
      console.log('‚ùå Erro ao buscar votos:', votesError.message);
      return;
    }
    
    console.log(`üìä Total de votos existentes: ${existingVotes?.length || 0}`);
    
    if (existingVotes && existingVotes.length > 0) {
      console.log('\nüîç Verificando usu√°rios dos votos existentes...');
      
      const userIds = [...new Set(existingVotes.map(v => v.usuario_id))];
      const validVotes = [];
      const invalidVotes = [];
      
      for (const userId of userIds) {
        const { data: user, error: userError } = await adminSupabase
          .from('users')
          .select('id, email')
          .eq('id', userId)
          .single();
        
        const votesForUser = existingVotes.filter(v => v.usuario_id === userId);
        
        if (userError) {
          console.log(`‚ùå Usu√°rio ${userId} n√£o encontrado em public.users`);
          invalidVotes.push(...votesForUser);
        } else {
          console.log(`‚úÖ Usu√°rio ${user.email} (${userId}) v√°lido`);
          validVotes.push(...votesForUser);
        }
      }
      
      console.log(`\nüìä Votos v√°lidos: ${validVotes.length}`);
      console.log(`üìä Votos inv√°lidos: ${invalidVotes.length}`);
      
      // 2. Corrigir votos inv√°lidos
      if (invalidVotes.length > 0) {
        console.log('\nüîß 2. Corrigindo votos inv√°lidos...');
        
        for (const invalidVote of invalidVotes) {
          console.log(`\nüîç Processando voto inv√°lido ID: ${invalidVote.id}`);
          console.log(`   Usu√°rio inv√°lido: ${invalidVote.usuario_id}`);
          
          // Tentar encontrar o usu√°rio correspondente em auth.users
          // e criar/sincronizar na public.users
          try {
            // Buscar na tabela auth.users usando o adminSupabase
            const { data: authUsers, error: authError } = await adminSupabase
              .rpc('get_auth_users'); // Fun√ß√£o personalizada se existir
            
            if (authError) {
              console.log('   ‚ùå N√£o conseguiu buscar em auth.users:', authError.message);
              
              // Alternativa: deletar o voto inv√°lido
              console.log('   üóëÔ∏è Deletando voto inv√°lido...');
              const { error: deleteError } = await adminSupabase
                .from('votos')
                .delete()
                .eq('id', invalidVote.id);
              
              if (deleteError) {
                console.log('   ‚ùå Erro ao deletar voto:', deleteError.message);
              } else {
                console.log('   ‚úÖ Voto inv√°lido deletado');
              }
            }
          } catch (err) {
            console.log('   ‚ùå Erro ao processar voto inv√°lido:', err.message);
            
            // Deletar o voto inv√°lido como √∫ltimo recurso
            console.log('   üóëÔ∏è Deletando voto inv√°lido como √∫ltimo recurso...');
            const { error: deleteError } = await adminSupabase
              .from('votos')
              .delete()
              .eq('id', invalidVote.id);
            
            if (deleteError) {
              console.log('   ‚ùå Erro ao deletar voto:', deleteError.message);
            } else {
              console.log('   ‚úÖ Voto inv√°lido deletado');
            }
          }
        }
      }
    }
    
    // 3. Testar inser√ß√£o de novo voto
    console.log('\nüó≥Ô∏è 3. Testando inser√ß√£o de novo voto...');
    
    // Buscar usu√°rio v√°lido
    const { data: testUser, error: userError } = await adminSupabase
      .from('users')
      .select('*')
      .eq('email', 'maumautremeterra@gmail.com')
      .single();
    
    if (userError) {
      console.log('‚ùå Usu√°rio de teste n√£o encontrado:', userError.message);
      return;
    }
    
    console.log(`‚úÖ Usu√°rio de teste encontrado: ${testUser.email}`);
    
    // Buscar pesquisa para teste
    const { data: testSurvey, error: surveyError } = await adminSupabase
      .from('pesquisas')
      .select('*')
      .limit(1)
      .single();
    
    if (surveyError || !testSurvey) {
      console.log('‚ùå Pesquisa de teste n√£o encontrada:', surveyError?.message);
      return;
    }
    
    if (!testSurvey.opcoes || testSurvey.opcoes.length === 0) {
      console.log('‚ùå Pesquisa n√£o tem op√ß√µes v√°lidas');
      return;
    }
    
    const testOption = testSurvey.opcoes[0];
    console.log(`üìä Testando com pesquisa: ${testSurvey.titulo}`);
    console.log(`üìù Op√ß√£o: ${testOption.texto || testOption.title}`);
    
    // Deletar voto existente se houver
    await adminSupabase
      .from('votos')
      .delete()
      .eq('pesquisa_id', testSurvey.id)
      .eq('usuario_id', testUser.id);
    
    // Tentar inserir novo voto
    const { data: newVote, error: voteError } = await adminSupabase
      .from('votos')
      .insert({
        pesquisa_id: testSurvey.id,
        usuario_id: testUser.id,
        opcao_id: testOption.id,
        comentario: 'Teste final - solu√ß√£o completa',
        user_ip: '127.0.0.1',
        user_agent: 'Final Test Agent'
      })
      .select()
      .single();
    
    if (voteError) {
      console.log('‚ùå AINDA H√Å ERRO ao inserir voto:', voteError.message);
      console.log('‚ùå C√≥digo:', voteError.code);
      console.log('‚ùå Detalhes:', voteError.details);
      
      console.log('\n‚ö†Ô∏è SOLU√á√ÉO MANUAL NECESS√ÅRIA:');
      console.log('1. Acesse o painel do Supabase');
      console.log('2. V√° para SQL Editor');
      console.log('3. Execute os seguintes comandos:');
      console.log('');
      console.log('-- Dropar constraint existente');
      console.log('ALTER TABLE votos DROP CONSTRAINT IF EXISTS votos_usuario_id_fkey;');
      console.log('');
      console.log('-- Adicionar nova constraint');
      console.log('ALTER TABLE votos ADD CONSTRAINT votos_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES public.users(id);');
      console.log('');
      console.log('4. Ap√≥s executar, rode este script novamente para testar');
      
    } else {
      console.log('\nüéâ SUCESSO TOTAL!');
      console.log('‚úÖ Voto inserido com sucesso!');
      console.log('üìä Dados do voto:', newVote);
      
      console.log('\n‚úÖ PROBLEMA RESOLVIDO!');
      console.log('‚úÖ A tabela votos agora est√° funcionando corretamente');
      console.log('‚úÖ Usu√°rios podem votar normalmente');
    }
    
  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
  
  process.exit(0);
})();