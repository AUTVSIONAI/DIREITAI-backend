const { supabase } = require('./config/supabase');

async function checkUserGoalsTable() {
  try {
    console.log('üîç Verificando se a tabela user_goals existe...');
    
    // Tentar fazer uma query simples na tabela para verificar se existe
    const { data: testQuery, error: testError } = await supabase
      .from('user_goals')
      .select('id')
      .limit(1);
    
    if (testError) {
      if (testError.code === '42P01') {
        console.log('‚ùå Tabela user_goals n√£o existe!');
        console.log('üí° Execute o SQL para criar a tabela primeiro.');
        return;
      } else {
        console.error('‚ùå Erro ao acessar tabela:', testError);
        return;
      }
    }
    
    console.log('‚úÖ Tabela user_goals existe e est√° acess√≠vel!');
    
    // Contar registros existentes
    const { count, error: countError } = await supabase
      .from('user_goals')
      .select('*', { count: 'exact', head: true });
    
    if (!countError) {
      console.log(`üìä Total de metas na tabela: ${count || 0}`);
    }
    
    // Testar inser√ß√£o de uma meta de exemplo
    console.log('\nüß™ Testando cria√ß√£o de meta autom√°tica...');
    
    // Buscar um usu√°rio existente para teste
    const { data: users, error: usersError } = await supabase
      .from('users')
      .select('id, auth_id, level')
      .limit(1);
    
    if (usersError || !users || users.length === 0) {
      console.log('‚ö†Ô∏è Nenhum usu√°rio encontrado para teste');
      return;
    }
    
    const testUser = users[0];
    console.log(`üìù Usando usu√°rio de teste: ${testUser.id} (n√≠vel ${testUser.level || 1})`);
    
    // Verificar se j√° existe uma meta para este usu√°rio no m√™s atual
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    
    const { data: existingGoals } = await supabase
      .from('user_goals')
      .select('*')
      .eq('user_id', testUser.auth_id)
      .eq('goal_type', 'monthly_points')
      .eq('period_start', monthStart)
      .eq('period_end', monthEnd);
    
    if (existingGoals && existingGoals.length > 0) {
      console.log('‚úÖ Meta mensal j√° existe para este usu√°rio:');
      console.log(JSON.stringify(existingGoals[0], null, 2));
    } else {
      // Criar meta de teste
      const targetValue = Math.max(500, (testUser.level || 1) * 100);
      
      const { data: newGoal, error: goalError } = await supabase
        .from('user_goals')
        .insert({
          user_id: testUser.auth_id,
          goal_type: 'monthly_points',
          target_value: targetValue,
          current_value: 0,
          period_start: monthStart,
          period_end: monthEnd,
          status: 'active',
          auto_generated: true
        })
        .select()
        .single();
      
      if (goalError) {
        console.error('‚ùå Erro ao criar meta de teste:', goalError);
      } else {
        console.log('‚úÖ Meta de teste criada com sucesso:');
        console.log(JSON.stringify(newGoal, null, 2));
      }
    }
    
    console.log('\nüéâ Verifica√ß√£o da tabela user_goals conclu√≠da!');
    
  } catch (error) {
    console.error('‚ùå Erro durante a verifica√ß√£o:', error);
  }
}

checkUserGoalsTable();