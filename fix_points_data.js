const { supabase } = require('./config/supabase');

async function fixPointsData() {
  try {
    console.log('üîß Corrigindo dados de pontos...');
    
    // Primeiro, vamos ver qual user_id funciona na tabela points
    const { data: existingPoints, error: pointsError } = await supabase
      .from('points')
      .select('user_id')
      .limit(1);
    
    if (pointsError) {
      console.log('‚ùå Erro ao buscar pontos existentes:', pointsError);
      return;
    }
    
    if (existingPoints.length > 0) {
      const workingUserId = existingPoints[0].user_id;
      console.log('‚úÖ User ID que funciona:', workingUserId);
      
      // Verificar se este user_id existe na tabela users
      const { data: workingUser, error: userError } = await supabase
        .from('users')
        .select('*')
        .eq('id', workingUserId)
        .limit(1);
      
      if (userError) {
        console.log('‚ùå Erro ao buscar usu√°rio que funciona:', userError);
      } else if (workingUser.length > 0) {
        console.log('‚úÖ Usu√°rio que funciona:', workingUser[0].email);
      } else {
        console.log('‚ùå Usu√°rio que funciona n√£o encontrado na tabela users');
      }
    }
    
    // Agora vamos tentar uma abordagem diferente: atualizar os pontos existentes
    // para o nosso usu√°rio de teste
    const ourUserId = 'bcd0593a-ba47-4262-8f8f-cb32f97e58d6';
    
    console.log('\nüîÑ Tentando atualizar pontos existentes para nosso usu√°rio...');
    
    // Primeiro, vamos limpar pontos antigos se existirem
    const { error: deleteError } = await supabase
      .from('points')
      .delete()
      .eq('user_id', ourUserId);
    
    if (deleteError) {
      console.log('‚ö†Ô∏è Aviso ao deletar pontos antigos:', deleteError.message);
    }
    
    // Agora vamos tentar uma inser√ß√£o direta usando SQL
    console.log('\nüíæ Tentando inser√ß√£o direta...');
    
    const { data: sqlResult, error: sqlError } = await supabase.rpc('insert_test_points', {
      p_user_id: ourUserId,
      p_amount: 100,
      p_reason: 'Teste de pontos',
      p_source: 'system'
    });
    
    if (sqlError) {
      console.log('‚ùå Erro na fun√ß√£o SQL:', sqlError);
      
      // Se a fun√ß√£o n√£o existe, vamos tentar uma abordagem mais simples
      console.log('\nüîÑ Tentando abordagem alternativa...');
      
      // Vamos verificar se podemos inserir usando o auth_id em vez do id
      const { data: userByAuth, error: authError } = await supabase
        .from('users')
        .select('auth_id')
        .eq('email', 'maumautremeterra@gmail.com')
        .limit(1);
      
      if (!authError && userByAuth.length > 0) {
        console.log('üîë Auth ID do usu√°rio:', userByAuth[0].auth_id);
        
        // Tentar inserir usando auth_id
        const testPointWithAuth = {
          user_id: userByAuth[0].auth_id,
          amount: 100,
          reason: 'Teste com auth_id',
          source: 'system'
        };
        
        const { data: authResult, error: authInsertError } = await supabase
          .from('points')
          .insert([testPointWithAuth])
          .select();
        
        if (authInsertError) {
          console.log('‚ùå Erro com auth_id tamb√©m:', authInsertError);
        } else {
          console.log('‚úÖ Sucesso com auth_id!', authResult);
        }
      }
    } else {
      console.log('‚úÖ Fun√ß√£o SQL executada com sucesso:', sqlResult);
    }
    
  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
}

fixPointsData();