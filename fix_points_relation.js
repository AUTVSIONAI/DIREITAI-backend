const { supabase } = require('./config/supabase');

// Script para corrigir a rela√ß√£o entre tabelas points e users
async function fixPointsRelation() {
  try {
    console.log('üîç Verificando estrutura das tabelas...');
    
    // Verificar se a tabela points existe e sua estrutura
    const { data: pointsData, error: pointsError } = await supabase
      .from('points')
      .select('*')
      .limit(1);
    
    console.log('‚úÖ Tabela points existe:', !pointsError);
    if (pointsError) {
      console.log('‚ùå Erro na tabela points:', pointsError);
    }
    
    // Verificar se a tabela users existe
    const { data: usersData, error: usersError } = await supabase
      .from('users')
      .select('id, auth_id, email')
      .limit(1);
    
    console.log('‚úÖ Tabela users existe:', !usersError);
    if (usersError) {
      console.log('‚ùå Erro na tabela users:', usersError);
    }
    
    // Testar query com join manual
    console.log('\nüîç Testando join manual entre points e users...');
    
    const { data: allPoints, error: allPointsError } = await supabase
      .from('points')
      .select('*');
    
    if (allPointsError) {
      console.log('‚ùå Erro ao buscar pontos:', allPointsError);
      return;
    }
    
    console.log('üìä Total de registros de pontos:', allPoints?.length || 0);
    
    if (allPoints && allPoints.length > 0) {
      // Para cada ponto, buscar o usu√°rio correspondente
      const pointsWithUsers = [];
      
      for (const point of allPoints) {
        const { data: user, error: userError } = await supabase
          .from('users')
          .select('id, auth_id, email, full_name, username')
          .eq('auth_id', point.user_id)
          .single();
        
        if (!userError && user) {
          pointsWithUsers.push({
            ...point,
            user: user
          });
        } else {
          console.log(`‚ö†Ô∏è Usu√°rio n√£o encontrado para user_id: ${point.user_id}`);
        }
      }
      
      console.log('‚úÖ Pontos com usu√°rios encontrados:', pointsWithUsers.length);
      
      // Calcular ranking
      const userPointsMap = {};
      pointsWithUsers.forEach(point => {
        const userId = point.user_id;
        if (!userPointsMap[userId]) {
          userPointsMap[userId] = {
            user: point.user,
            totalPoints: 0,
            transactions: []
          };
        }
        userPointsMap[userId].totalPoints += point.amount;
        userPointsMap[userId].transactions.push({
          amount: point.amount,
          reason: point.reason,
          created_at: point.created_at
        });
      });
      
      // Converter para array e ordenar por pontos
      const ranking = Object.values(userPointsMap)
        .sort((a, b) => b.totalPoints - a.totalPoints);
      
      console.log('\nüìä RANKING CALCULADO:');
      ranking.forEach((entry, index) => {
        console.log(`${index + 1}. ${entry.user.email || entry.user.username || 'Usu√°rio'} - ${entry.totalPoints} pontos`);
      });
      
      console.log('\nüìã DETALHES DOS PONTOS:');
      ranking.forEach(entry => {
        console.log(`\nüë§ ${entry.user.email}:`);
        entry.transactions.forEach(transaction => {
          console.log(`  ‚Ä¢ ${transaction.amount} pontos - ${transaction.reason} (${transaction.created_at})`);
        });
      });
      
    } else {
      console.log('‚ö†Ô∏è Nenhum ponto encontrado no banco de dados');
    }
    
  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
}

fixPointsRelation();