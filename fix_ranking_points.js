const { supabase } = require('./config/supabase');

async function fixRankingPoints() {
  try {
    console.log('üéØ Corrigindo pontos para o sistema de ranking...');
    
    // Buscar o usu√°rio pelo email para obter os IDs corretos
    const { data: users, error } = await supabase
      .from('users')
      .select('id, auth_id, email, full_name')
      .eq('email', 'maumautremeterra@gmail.com')
      .limit(1);
    
    if (error || !users || users.length === 0) {
      console.log('‚ùå Usu√°rio n√£o encontrado');
      return;
    }
    
    const user = users[0];
    console.log('üë§ Usu√°rio:', user.email);
    console.log('üÜî Public ID:', user.id);
    console.log('üîë Auth ID:', user.auth_id);
    
    // Limpar pontos existentes para este usu√°rio (usando ambos os IDs)
    console.log('\nüßπ Limpando pontos existentes...');
    await supabase.from('points').delete().eq('user_id', user.id);
    await supabase.from('points').delete().eq('user_id', user.auth_id);
    
    // Inserir pontos de teste usando o ID da tabela public.users
    const pointsToAdd = [
      {
        user_id: user.id, // Usar o ID da tabela public.users
        amount: 100,
        reason: 'B√¥nus de boas-vindas',
        source: 'system',
        category: 'general'
      },
      {
        user_id: user.id,
        amount: 50,
        reason: 'Primeiro acesso',
        source: 'system',
        category: 'general'
      },
      {
        user_id: user.id,
        amount: 30,
        reason: 'Participa√ß√£o em manifesta√ß√£o',
        source: 'event',
        category: 'event'
      },
      {
        user_id: user.id,
        amount: 25,
        reason: 'Perfil completo',
        source: 'system',
        category: 'profile'
      },
      {
        user_id: user.id,
        amount: 20,
        reason: 'Conversa com IA - D√∫vida sobre direitos',
        source: 'ai_chat',
        category: 'ai_interaction'
      },
      {
        user_id: user.id,
        amount: 15,
        reason: 'Conversa com IA - Consulta jur√≠dica',
        source: 'ai_chat',
        category: 'ai_interaction'
      },
      {
        user_id: user.id,
        amount: 10,
        reason: 'Login di√°rio',
        source: 'system',
        category: 'daily'
      }
    ];
    
    console.log('\nüíæ Inserindo pontos de teste...');
    const { data: insertedPoints, error: insertError } = await supabase
      .from('points')
      .insert(pointsToAdd)
      .select();
    
    if (insertError) {
      console.log('‚ùå Erro ao inserir pontos:', insertError);
      return;
    }
    
    console.log('‚úÖ Pontos inseridos com sucesso!');
    console.log('üìä Total de pontos inseridos:', insertedPoints.length);
    
    // Calcular total de pontos
    const totalPoints = insertedPoints.reduce((sum, point) => sum + point.amount, 0);
    console.log('üéØ Total de pontos:', totalPoints);
    
    // Verificar se os pontos foram inseridos corretamente
    const { data: verifyPoints, error: verifyError } = await supabase
      .from('points')
      .select('*')
      .eq('user_id', user.id);
    
    if (!verifyError && verifyPoints) {
      console.log('\n‚úÖ Verifica√ß√£o: Pontos encontrados:', verifyPoints.length);
      console.log('üéØ Total verificado:', verifyPoints.reduce((sum, p) => sum + p.amount, 0));
    }
    
  } catch (error) {
    console.error('‚ùå Erro geral:', error);
  }
}

fixRankingPoints();