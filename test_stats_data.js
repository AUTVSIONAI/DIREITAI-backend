const { supabase } = require('./config/supabase');

async function getStatsData() {
  try {
    console.log('üìä Buscando dados de estat√≠sticas...');

    // 1. Total de usu√°rios ativos (com pontos > 0)
    const { data: usersWithPoints, error: usersError } = await supabase
      .from('users')
      .select('id')
      .gte('points', 1);

    if (usersError) {
      console.error('‚ùå Erro ao buscar usu√°rios com pontos:', usersError);
    }

    // 2. Total de usu√°rios na plataforma
    const { data: allUsers, error: allUsersError } = await supabase
      .from('users')
      .select('id, created_at');

    if (allUsersError) {
      console.error('‚ùå Erro ao buscar todos os usu√°rios:', allUsersError);
    }

    // 3. Total de pontos/atividades (simulando check-ins)
    const { data: pointsData, error: pointsError } = await supabase
      .from('points')
      .select('id, created_at, amount');

    if (pointsError) {
      console.error('‚ùå Erro ao buscar pontos:', pointsError);
    }

    // 4. Calcular crescimento (usu√°rios criados no √∫ltimo m√™s vs m√™s anterior)
    const now = new Date();
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const twoMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);

    const usersLastMonth = allUsers?.filter(user => {
      const createdAt = new Date(user.created_at);
      return createdAt >= lastMonth && createdAt < now;
    }).length || 0;

    const usersTwoMonthsAgo = allUsers?.filter(user => {
      const createdAt = new Date(user.created_at);
      return createdAt >= twoMonthsAgo && createdAt < lastMonth;
    }).length || 0;

    const growthPercentage = usersTwoMonthsAgo > 0 
      ? Math.round(((usersLastMonth - usersTwoMonthsAgo) / usersTwoMonthsAgo) * 100)
      : 0;

    // 5. Estat√≠sticas por per√≠odo (semana/m√™s)
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());

    const pointsThisWeek = pointsData?.filter(point => {
      const createdAt = new Date(point.created_at);
      return createdAt >= oneWeekAgo;
    }).length || 0;

    const pointsThisMonth = pointsData?.filter(point => {
      const createdAt = new Date(point.created_at);
      return createdAt >= oneMonthAgo;
    }).length || 0;

    console.log('\nüìä ESTAT√çSTICAS DA PLATAFORMA:');
    console.log('================================');
    console.log(`üë• Total de usu√°rios: ${allUsers?.length || 0}`);
    console.log(`‚≠ê Usu√°rios com pontos: ${usersWithPoints?.length || 0}`);
    console.log(`üìà Total de atividades/pontos: ${pointsData?.length || 0}`);
    console.log(`üìÖ Atividades esta semana: ${pointsThisWeek}`);
    console.log(`üìÖ Atividades este m√™s: ${pointsThisMonth}`);
    console.log(`üìä Crescimento mensal: ${growthPercentage > 0 ? '+' : ''}${growthPercentage}%`);
    console.log(`üìä Usu√°rios novos √∫ltimo m√™s: ${usersLastMonth}`);
    console.log(`üìä Usu√°rios novos m√™s anterior: ${usersTwoMonthsAgo}`);

    return {
      totalUsers: allUsers?.length || 0,
      activeUsers: usersWithPoints?.length || 0,
      totalActivities: pointsData?.length || 0,
      activitiesThisWeek: pointsThisWeek,
      activitiesThisMonth: pointsThisMonth,
      growthPercentage,
      newUsersLastMonth: usersLastMonth,
      newUsersTwoMonthsAgo: usersTwoMonthsAgo
    };

  } catch (error) {
    console.error('‚ùå Erro geral:', error);
    return null;
  }
}

getStatsData().then(() => {
  console.log('\n‚úÖ Teste de estat√≠sticas conclu√≠do!');
  process.exit(0);
}).catch(error => {
  console.error('‚ùå Erro no teste:', error);
  process.exit(1);
});